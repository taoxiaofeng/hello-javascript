<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- <meta http-equiv="Content-Security-Policy" content="frame-ancestors 'self' http://10.1.1.120:9999"> -->
    <title>Document</title>
    <style>
        * {
            margin: 0;
            padding: 0;
        }
        
        html,
        body {
            width: 100%;
            height: 100%;
        }
        
        button {
            margin: 10px;
            height: 34px;
            color: #fff;
            background-color: #108ee9;
            border-color: #108ee9;
            min-width: 68px;
            display: inline-block;
            font-weight: 400;
            text-align: center;
            white-space: nowrap;
            vertical-align: middle;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            border: 1px solid transparent;
            font-size: .8125rem;
            line-height: 1.5;
            border-radius: .25rem;
            transition: color .15s ease-in-out, background-color .15s ease-in-out, border-color .15s ease-in-out, box-shadow .15s ease-in-out;
        }
    </style>
    <!--[if IE 6]>
        <style type="text/css">
            html{
                overflow:hidden;
            }
            body{
                height:100%;
                overflow:auto;
            }
            #notification-node {
                position:absolute;
            }
        </style>
    <![endif]-->
    <script>
        // From https://github.com/douglascrockford/JSON-js/blob/master/json2.js
        // if (typeof JSON.parse !== "function") {
        //     var rx_one = /^[\],:{}\s]*$/;
        //     var rx_two = /\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g;
        //     var rx_three = /"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g;
        //     var rx_four = /(?:^|:|,)(?:\s*\[)+/g;
        //     var rx_dangerous =
        //         /[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g;
        //     JSON.parse = function(text, reviver) {

        //         // The parse method takes a text and an optional reviver function, and returns
        //         // a JavaScript value if the text is a valid JSON text.

        //         var j;

        //         function walk(holder, key) {

        //             // The walk method is used to recursively walk the resulting structure so
        //             // that modifications can be made.

        //             var k;
        //             var v;
        //             var value = holder[key];
        //             if (value && typeof value === "object") {
        //                 for (k in value) {
        //                     if (Object.prototype.hasOwnProperty.call(value, k)) {
        //                         v = walk(value, k);
        //                         if (v !== undefined) {
        //                             value[k] = v;
        //                         } else {
        //                             delete value[k];
        //                         }
        //                     }
        //                 }
        //             }
        //             return reviver.call(holder, key, value);
        //         }


        //         // Parsing happens in four stages. In the first stage, we replace certain
        //         // Unicode characters with escape sequences. JavaScript handles many characters
        //         // incorrectly, either silently deleting them, or treating them as line endings.

        //         text = String(text);
        //         rx_dangerous.lastIndex = 0;
        //         if (rx_dangerous.test(text)) {
        //             text = text.replace(rx_dangerous, function(a) {
        //                 return (
        //                     "\\u" +
        //                     ("0000" + a.charCodeAt(0).toString(16)).slice(-4)
        //                 );
        //             });
        //         }

        //         // In the second stage, we run the text against regular expressions that look
        //         // for non-JSON patterns. We are especially concerned with "()" and "new"
        //         // because they can cause invocation, and "=" because it can cause mutation.
        //         // But just to be safe, we want to reject all unexpected forms.

        //         // We split the second stage into 4 regexp operations in order to work around
        //         // crippling inefficiencies in IE's and Safari's regexp engines. First we
        //         // replace the JSON backslash pairs with "@" (a non-JSON character). Second, we
        //         // replace all simple value tokens with "]" characters. Third, we delete all
        //         // open brackets that follow a colon or comma or that begin the text. Finally,
        //         // we look to see that the remaining characters are only whitespace or "]" or
        //         // "," or ":" or "{" or "}". If that is so, then the text is safe for eval.

        //         if (
        //             rx_one.test(
        //                 text
        //                 .replace(rx_two, "@")
        //                 .replace(rx_three, "]")
        //                 .replace(rx_four, "")
        //             )
        //         ) {

        //             // In the third stage we use the eval function to compile the text into a
        //             // JavaScript structure. The "{" operator is subject to a syntactic ambiguity
        //             // in JavaScript: it can begin a block or an object literal. We wrap the text
        //             // in parens to eliminate the ambiguity.

        //             j = eval("(" + text + ")");

        //             // In the optional fourth stage, we recursively walk the new structure, passing
        //             // each name/value pair to a reviver function for possible transformation.

        //             return (typeof reviver === "function") ?
        //                 walk({
        //                     "": j
        //                 }, "") :
        //                 j;
        //         }

        //         // If the text is not JSON parseable, then a SyntaxError is thrown.

        //         throw new SyntaxError("JSON.parse");
        //     };
        // }
    </script>
    <script>
        window.onload = function() {

            var bodyNodes = nodeListToArr(document.body.childNodes || []);
            var shadeBtn = document.getElementById('create-shade');
            var notificationBtn = document.getElementById('create-notification');
            var shadeIndex = 0;
            var notificationIndex = 0;
            var msgCount = 0;

            // 浏览器监听关闭
            window.onbeforeunload = function(e) {
                e = e || window.event;

                // 兼容IE8和Firefox 4之前的版本
                if (e) {
                    e.returnValue = '关闭提示';
                }

                // Chrome, Safari, Firefox 4+, Opera 12+ , IE 9+
                return '关闭提示';
            };

            // 封装一个 showModalDialog
            var has_showModalDialog = !!window.showModalDialog; //定义一个全局变量判定是否有原生showModalDialog方法
            if (!has_showModalDialog && !!(window.opener)) {
                window.onbeforeunload = function() {
                    window.opener.hasOpenWindow = false; //弹窗关闭时告诉opener：它子窗口已经关闭
                }
            }
            //定义window.showModalDialog如果它不存在
            if (window.showModalDialog == undefined) {
                window.showModalDialog = function(url, mixedVar, features) {
                    // if (window.hasOpenWindow) {
                    //     alert("您已经打开了一个窗口！请先处理它"); //避免多次点击会弹出多个窗口
                    //     window.myNewWindow.focus();
                    //     return false;
                    // }
                    window.hasOpenWindow = true;
                    if (mixedVar) var mixedVar = mixedVar;
                    //因window.showmodaldialog 与 window.open 参数不一样，所以封装的时候用正则去格式化一下参数
                    if (features) var features = features.replace(/(dialog)|(px)/ig, "").replace(/;/g, ',')
                        .replace(/\:/g, "=");
                    //window.open("Sample.htm",null,"height=200,width=400,status=yes,toolbar=no,menubar=no");
                    //window.showModalDialog("modal.htm",obj,"dialogWidth=200px;dialogHeight=100px"); 
                    var left = (window.screen.width - parseInt(features.match(/width[\s]*=[\s]*([\d]+)/i)[1])) /
                        2;
                    var top = (window.screen.height - parseInt(features.match(/height[\s]*=[\s]*([\d]+)/i)[
                        1])) / 2;
                    window.myNewWindow = window.open(url, mixedVar, features);
                }
            }

            // 创建遮罩
            if (window.attachEvent) {
                shadeBtn.attachEvent('onclick', createShade);
            } else if (window.addEventListener) {
                shadeBtn.addEventListener('click', createShade);
            }

            function createShade() {
                removeAppointNode(bodyNodes, 'shade-node');


                var shadeDiv = document.createElement('div');
                shadeDiv.setAttribute('shade-index', shadeIndex++);
                shadeDiv.setAttribute('id', 'shade-node')
                    // shadeDiv.style.cssText =
                    //     'position: absolute;' +
                    //     'top: 0;' +
                    //     'right: 0;' +
                    //     'bottom: 0;' +
                    //     'left: 0;' +
                    //     'background: rgba(0,0,0,.3)';
                document.body.appendChild(shadeDiv);
                bodyNodes = nodeListToArr(document.body.childNodes || []);
                _showModalDialog();

                // 打开 showModalDialog 后关闭， 关闭获取消息的定时器
                clearInterval(taskInterval);
            }

            // 创建通知
            if (window.attachEvent) {
                notificationBtn.attachEvent('onclick', createNotification);
            } else if (window.addEventListener) {
                notificationBtn.addEventListener('click', createNotification);
            }

            // 创建消息通知
            function createNotification() {

                removeAppointNode(bodyNodes, 'notification-node');
                var notificationEl = document.createElement('div');
                notificationEl.style.cssText =
                    'width: 360px;' +
                    'height: 120px;' +
                    'line-height:120px;' +
                    'color:#333333;' +
                    'font-size:14px;' +
                    'padding：10px;' +
                    'text-align:center;' +
                    'background: #48dbfb;' +
                    'position: absolute;' +
                    'right: 10px;' +
                    'bottom: 10px;' +
                    'z-index: 10;' +
                    'cursor: pointer;';
                notificationEl.innerHTML = '您有<b>' + msgCount + '</b>条新的消息，请点击查看。';
                notificationEl.setAttribute('id', 'notification-node');
                notificationEl.setAttribute('notification-index', notificationIndex++);
                document.body.appendChild(notificationEl);

                notificationEl.onclick = function() {
                    document.body.removeChild(notificationEl);
                    notificationIndex--;
                    bodyNodes = nodeListToArr(document.body.childNodes || []);
                    createShade();
                }
                bodyNodes = nodeListToArr(document.body.childNodes || []);
            };

            // 删除 body 中指定的dom 节点
            function removeAppointNode(nodeList, id) {
                for (var i = 0, len = nodeList.length; i < len; i++) {
                    if (nodeList[i].id == id) {
                        document.body.removeChild(nodeList[i]);
                    };
                }
            };

            // nodelist 转 Array  => 兼容低版本 IE 写法
            function nodeListToArr(data) {
                var arr = [];
                try {
                    //ie8及以下不支持
                    arr = Array.prototype.slice.call(data);
                } catch (e) {
                    //兼容写法
                    var len = data.length;
                    for (var i = 0; i < len; i++) {
                        arr.push(data[i]);
                    }
                };
                return arr;
            };

            // 显示 showModalDialog
            function _showModalDialog() {
                var iWidth = 800;
                var iHeight = 600;
                var url =
                    "http://10.1.1.71:9999/client/index.html?userId=09&userName=王萌萌3&organizationCode=H0003&deptId=1900000&inPatientArea=1900001&groupId=1";
                // 以浏览器窗口来计算
                // 获得窗口的垂直位置 
                var iTop = (window.screen.availHeight - 30 - iHeight) / 2;
                // 获得窗口的水平位置 
                var iLeft = (window.screen.availWidth - 10 - iWidth) / 2;

                var winOption = "dialogWidth:800px;dialogHeight:600px;dialogTop:" + iTop + ";dialogLeft:" + iLeft +
                    ";center:yes;resizable:yes;scroll:yes;status=0;"

                window.showModalDialog(url, '审方消息客户端', winOption);

            };

            // 获取消息
            // TODO 获取消息时存在跨域问题 ，带解决
            // function accessToTask() {
            //     var xmlhttp;
            //     var result;
            //     var nowDate = new Date().getTime();
            //     var tempUrl = '/auditcenter/api/v1/reject/backTaskCount?&t=' + nowDate;
            //     var tempParams = {
            //         deptId: "1900000",
            //         groupId: "1、",
            //         inPatientArea: "1900001",
            //         nameOrBedno: null,
            //         organizationCode: "H0003",
            //         status: 0,
            //         userId: "09",
            //         userName: "王萌萌3",
            //     }
            //     if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
            //         xmlhttp = new XMLHttpRequest();
            //     } else { // code for IE6, IE5
            //         xmlhttp = new ActiveXObject("Microsoft.XMLHTTP");
            //     }
            //     xmlhttp.onreadystatechange = function() {
            //         if (xmlhttp.readyState == 4) {
            //             if (xmlhttp.status == 200) {
            //                 if (xmlhttp.response) {
            //                     result = JSON.parse(xmlhttp.response);
            //                     msgCount = result.data.unCount;
            //                 }
            //                 if (msgCount > 0) {
            //                     createNotification();
            //                 }
            //             } else {
            //                 clearInterval(taskInterval);
            //             }
            //         }
            //     }

            //     xmlhttp.open('POST', tempUrl, true);
            //     xmlhttp.setRequestHeader('Content-type', 'application/json;charset-UTF-8');
            //     xmlhttp.send(JSON.stringify(tempParams));
            // }

            // 轮询获取消息
            var taskInterval = null;
            // taskInterval = setInterval(function() {
            //     accessToTask();
            // }, 2000);

            // 实时监听 showModalDialog 是否关闭
            var taskIntervalCount = 0;
            var dialogStatusMonitor = setInterval(function() {
                if (window.myNewWindow) {
                    // if (window.myNewWindow.closed && taskIntervalCount == 0) {
                    //     taskInterval = setInterval(function () {
                    //         accessToTask();
                    //     }, 2000);
                    // }
                }
            }, 1000);
            // var _opener = function (child) {
            // }
        }
    </script>
</head>

<body>
    <button id="create-shade">打开审方客户端</button>
    <button id="create-notification">创建通知</button>
</body>

</html>